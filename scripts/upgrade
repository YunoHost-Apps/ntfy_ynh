#!/bin/bash

source /usr/share/yunohost/helpers
source _common.sh

ynh_script_progression -m "Checking version..." -w 1
upgrade_type=$(ynh_check_app_version_changed)

if [ "$upgrade_type" == "UPGRADE_APP" ]
then
	ynh_script_progression -m "Upgrading source files..." -w 1
	ntfy_setup_source
fi

ynh_script_progression -m "Upgrading web server configuration..." -w 2
ynh_add_nginx_config

ynh_script_progression -m "Updating configuration file..." -w 1
ynh_add_config -t "server.yml" -d "$install_dir/server.yml"

ynh_script_progression -m "Updating simple command wrapper..." -w 1
ynh_add_config -t "ntfy.sh" -d "$install_dir/ntfy.sh"
chmod u+x "$install_dir/ntfy.sh"

ynh_script_progression -m "Upgrading systemd configuration..." -w 1
ynh_add_systemd_config

ynh_script_progression -m "Integrating service in YunoHost..." -w 1
yunohost service add $app

ynh_script_progression -m "Restarting systemd service..." -w 1
ynh_systemd_action -a restart

ynh_script_progression -m "Upgrade completed" -l